<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P3 Spotter</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, sans-serif;
        background: #05070f;
        color: #f8fafc;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
      }

      #app {
        display: grid;
        grid-template-columns: minmax(280px, 360px) 1fr;
        height: 100vh;
        background: radial-gradient(circle at top, #0f172a, #05070f 70%);
      }

      .panel {
        display: grid;
        gap: 18px;
        padding: 24px;
        background: rgba(7, 10, 20, 0.92);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(18px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .pulse {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: linear-gradient(135deg, #38f9d7, #2b8cff);
        box-shadow: 0 0 18px rgba(56, 249, 215, 0.7);
        animation: pulse 2s infinite;
      }

      h1 {
        margin: 0;
        font-size: 1.2rem;
      }

      .subtitle {
        margin: 0;
        font-size: 0.85rem;
        color: rgba(248, 250, 252, 0.65);
      }

      label {
        font-size: 0.8rem;
        color: rgba(248, 250, 252, 0.6);
        display: grid;
        gap: 8px;
      }

      input,
      button {
        font-family: inherit;
      }

      input[type="text"] {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(15, 23, 42, 0.7);
        color: #fff;
      }

      input[type="range"] {
        width: 100%;
        accent-color: #38f9d7;
      }

      button {
        padding: 10px 16px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #38f9d7, #2b8cff);
        color: #02030b;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 30px rgba(56, 249, 215, 0.25);
      }

      .results {
        display: grid;
        gap: 10px;
        max-height: 50vh;
        overflow-y: auto;
      }

      .card {
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.06);
        display: grid;
        gap: 4px;
      }

      .score {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: #38f9d7;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .leaflet-popup-content-wrapper {
        background: rgba(10, 15, 30, 0.95);
        color: #fff;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      @media (max-width: 900px) {
        #app {
          grid-template-columns: 1fr;
        }

        .panel {
          position: absolute;
          z-index: 900;
          width: min(360px, 90vw);
          height: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <section class="panel">
        <div class="brand">
          <span class="pulse"></span>
          <div>
            <h1>P3 Spotter</h1>
            <p class="subtitle">Surface high-value sites in seconds.</p>
          </div>
        </div>

        <label>
          Location
          <input id="location" type="text" placeholder="Enter city or address" />
        </label>

        <label>
          Search radius: <span id="radius-value">15</span> mi
          <input id="radius" type="range" min="5" max="100" value="15" />
        </label>

        <button id="search">Find P3 leads</button>
        <p class="subtitle" id="status">Ready to scan.</p>

        <div class="results" id="results"></div>
      </section>

      <div id="map"></div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const map = L.map("map", { zoomControl: false }).setView([39.1, -94.58], 11);
      L.control.zoom({ position: "topright" }).addTo(map);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const markerLayer = L.layerGroup().addTo(map);
      const resultsEl = document.getElementById("results");
      const statusEl = document.getElementById("status");
      const radiusEl = document.getElementById("radius");
      const radiusValueEl = document.getElementById("radius-value");

      radiusEl.addEventListener("input", () => {
        radiusValueEl.textContent = radiusEl.value;
      });

      async function geocode(query) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
          query
        )}`;
        const response = await fetch(url, {
          headers: { "Accept": "application/json" }
        });
        if (!response.ok) {
          throw new Error("Geocoding failed");
        }
        const data = await response.json();
        if (!data.length) {
          throw new Error("No results");
        }
        return {
          lat: Number(data[0].lat),
          lon: Number(data[0].lon),
          display: data[0].display_name
        };
      }

      function renderResults(results) {
        resultsEl.innerHTML = "";
        results.forEach((lead) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `<strong>${lead.title}</strong><span class="score">Score ${lead.score}</span>`;
          resultsEl.appendChild(card);
        });
      }

      async function search() {
        const locationInput = document.getElementById("location");
        const query = locationInput.value.trim();
        if (!query) {
          locationInput.focus();
          return;
        }
        resultsEl.innerHTML = "Searching...";
        statusEl.textContent = "Locating addressâ€¦";
        markerLayer.clearLayers();

        try {
          const geo = await geocode(query);
          statusEl.textContent = `Searching near ${geo.display}`;
          map.flyTo([geo.lat, geo.lon], 12, { duration: 1.2 });
          const radius = Number(radiusEl.value);
          const response = await fetch(
            `/search?lat=${geo.lat}&lon=${geo.lon}&radius=${radius}`
          );
          if (!response.ok) {
            throw new Error("Search failed");
          }
          const data = await response.json();
          renderResults(data.results);
          statusEl.textContent = `Found ${data.results.length} leads within ${radius} mi.`;

          data.results.forEach((lead) => {
            const marker = L.circleMarker([lead.lat, lead.lon], {
              radius: 8,
              color: "#38f9d7",
              fillColor: "#38f9d7",
              fillOpacity: 0.8
            });
            marker.bindPopup(
              `<strong>${lead.title}</strong><br/>Score ${lead.score}`
            );
            marker.addTo(markerLayer);
          });
        } catch (error) {
          resultsEl.innerHTML = `Unable to search: ${error.message}`;
          statusEl.textContent = "Search failed. Try another location.";
        }
      }

      document.getElementById("search").addEventListener("click", search);
      document.getElementById("location").addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          search();
        }
      });
    </script>
  </body>
</html>
